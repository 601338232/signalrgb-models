# .github/workflows/auto-index.yml
name: ğŸ”„ è‡ªåŠ¨åŒæ­¥æ¨¡å‹ç´¢å¼•ï¼ˆå¸¦ç¼©ç•¥å›¾ï¼‰

on:
  push:
    paths:
      - 'models/**'
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y libjpeg-dev zlib1g-dev libpng-dev
          pip install Pillow requests
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ› ï¸ åˆ›å»ºç”Ÿæˆè„šæœ¬
        run: |
          echo "åˆ›å»ºç¼©ç•¥å›¾ç”Ÿæˆè„šæœ¬..."
          
          # åˆ›å»ºscriptsç›®å½•
          mkdir -p scripts
          
          # ç”Ÿæˆå®Œæ•´çš„Pythonè„šæœ¬
          cat > scripts/generate_index_with_thumbnails.py << 'PYTHONEOF'
import os
import json
import base64
from datetime import datetime
import requests
from PIL import Image
import io

print("ğŸ–¼ï¸ SignalRGB æ¨¡å‹ç´¢å¼•ç”Ÿæˆå™¨ - å¸¦ç¼©ç•¥å›¾")
print("=" * 60)

def create_thumbnail_from_base64(base64_data, max_size=(80, 80)):
    """ä»Base64å›¾ç‰‡åˆ›å»ºç¼©ç•¥å›¾"""
    try:
        # ç§»é™¤data:imageå‰ç¼€
        if 'base64,' in base64_data:
            base64_data = base64_data.split('base64,')[1]
        
        # è§£ç Base64
        img_data = base64.b64decode(base64_data)
        img = Image.open(io.BytesIO(img_data))
        
        # è½¬æ¢ä¸ºRGBï¼ˆå¤„ç†é€æ˜èƒŒæ™¯ï¼‰
        if img.mode in ('RGBA', 'LA', 'P'):
            background = Image.new('RGB', img.size, (255, 255, 255))
            if img.mode == 'RGBA':
                r, g, b, a = img.split()
                img_rgb = Image.merge('RGB', (r, g, b))
                background.paste(img_rgb, mask=a)
            else:
                background.paste(img)
            img = background
        elif img.mode != 'RGB':
            img = img.convert('RGB')
        
        # ç”Ÿæˆç¼©ç•¥å›¾
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        # è½¬æ¢ä¸ºBase64
        buffered = io.BytesIO()
        img.save(buffered, format="PNG", optimize=True, quality=85)
        return "data:image/png;base64," + base64.b64encode(buffered.getvalue()).decode()
    except Exception as e:
        print(f"    âš ï¸ Base64ç¼©ç•¥å›¾å¤±è´¥: {str(e)[:50]}")
        return None

def create_thumbnail_from_url(url, max_size=(80, 80)):
    """ä»URLåˆ›å»ºç¼©ç•¥å›¾"""
    try:
        # è®¾ç½®User-Agent
        headers = {
            'User-Agent': 'Mozilla/5.0 (SignalRGB-Model-Indexer/1.0)'
        }
        
        # ä¸‹è½½å›¾ç‰‡ï¼ˆé™åˆ¶5MBï¼‰
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        
        if len(response.content) > 5 * 1024 * 1024:
            print(f"    âš ï¸ å›¾ç‰‡è¿‡å¤§ï¼Œè·³è¿‡")
            return None
        
        img = Image.open(io.BytesIO(response.content))
        
        # è½¬æ¢ä¸ºRGB
        if img.mode in ('RGBA', 'LA', 'P'):
            background = Image.new('RGB', img.size, (255, 255, 255))
            if img.mode == 'RGBA':
                r, g, b, a = img.split()
                img_rgb = Image.merge('RGB', (r, g, b))
                background.paste(img_rgb, mask=a)
            else:
                background.paste(img)
            img = background
        elif img.mode != 'RGB':
            img = img.convert('RGB')
        
        # ç”Ÿæˆç¼©ç•¥å›¾
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        # è½¬æ¢ä¸ºBase64
        buffered = io.BytesIO()
        img.save(buffered, format="PNG", optimize=True, quality=85)
        return "data:image/png;base64," + base64.b64encode(buffered.getvalue()).decode()
    except Exception as e:
        print(f"    âš ï¸ URLç¼©ç•¥å›¾å¤±è´¥: {str(e)[:50]}")
        return None

def generate_index():
    """ä¸»ç”Ÿæˆå‡½æ•°"""
    models_dir = "models"
    
    if not os.path.exists(models_dir):
        print(f"âŒ é”™è¯¯: '{models_dir}' ç›®å½•ä¸å­˜åœ¨")
        return None
    
    # è·å–æ‰€æœ‰JSONæ–‡ä»¶
    model_files = []
    for filename in os.listdir(models_dir):
        if filename.lower().endswith('.json') and filename != 'index.json':
            model_files.append(filename)
    
    print(f"ğŸ“ æ‰¾åˆ° {len(model_files)} ä¸ªæ¨¡å‹æ–‡ä»¶")
    print("-" * 60)
    
    models = []
    thumbnails_generated = 0
    
    for filename in sorted(model_files):
        filepath = os.path.join(models_dir, filename)
        print(f"ğŸ” å¤„ç†: {filename}")
        
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # åŸºæœ¬ä¿¡æ¯
            model_info = {
                "name": filename,
                "title": data.get('ProductName', filename.replace('.json', '')),
                "leds": data.get('LedCount', 0),
                "width": data.get('Width', 0),
                "height": data.get('Height', 0),
                "brand": data.get('Brand', 'CompGen'),
                "download": f"https://cdn.jsdelivr.net/gh/{os.environ.get('GITHUB_REPOSITORY', '601338232/signalrgb-models')}/main/models/{filename}",
                "imageType": "none",
                "thumbnail": None
            }
            
            # å¤„ç†å›¾ç‰‡
            if 'Image' in data and data['Image']:
                # Base64å›¾ç‰‡
                thumbnail = create_thumbnail_from_base64(data['Image'])
                if thumbnail:
                    model_info["thumbnail"] = thumbnail
                    model_info["imageType"] = "base64"
                    thumbnails_generated += 1
                    print(f"    âœ… Base64ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸ")
                else:
                    model_info["imageType"] = "base64"
                    print(f"    â„¹ï¸ Base64å›¾ç‰‡ï¼ˆç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥ï¼‰")
            
            elif 'ImageUrl' in data and data['ImageUrl']:
                # ç½‘ç»œå›¾ç‰‡
                image_url = data['ImageUrl']
                model_info["imageType"] = "url"
                
                # å°è¯•ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆGitHubå›¾ç‰‡é€šå¸¸å¯ä»¥ï¼‰
                if 'github.com' in image_url or 'raw.githubusercontent.com' in image_url:
                    thumbnail = create_thumbnail_from_url(image_url)
                    if thumbnail:
                        model_info["thumbnail"] = thumbnail
                        thumbnails_generated += 1
                        print(f"    âœ… GitHubå›¾ç‰‡ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸ")
                    else:
                        print(f"    â„¹ï¸ GitHubå›¾ç‰‡ï¼ˆç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥ï¼‰")
                else:
                    print(f"    â„¹ï¸ å¤–éƒ¨URLå›¾ç‰‡ï¼ˆè·³è¿‡ç¼©ç•¥å›¾ï¼‰")
            
            else:
                print(f"    â„¹ï¸ æ— å›¾ç‰‡")
            
            models.append(model_info)
            print(f"    ğŸ“Š {model_info['leds']} LED, {model_info['width']}Ã—{model_info['height']}")
            
        except json.JSONDecodeError as e:
            print(f"    âŒ JSONæ ¼å¼é”™è¯¯")
            # åˆ›å»ºåŸºæœ¬æ¨¡å‹ä¿¡æ¯ï¼ˆå³ä½¿JSONè§£æå¤±è´¥ï¼‰
            models.append({
                "name": filename,
                "title": filename.replace('.json', ''),
                "leds": 0,
                "width": 0,
                "height": 0,
                "brand": "Error",
                "download": f"https://cdn.jsdelivr.net/gh/{os.environ.get('GITHUB_REPOSITORY', '601338232/signalrgb-models')}/main/models/{filename}",
                "imageType": "none",
                "thumbnail": None
            })
        except Exception as e:
            print(f"    âŒ å¤„ç†å¤±è´¥: {str(e)[:50]}")
    
    # æ„å»ºç´¢å¼•æ•°æ®
    index_data = {
        "version": "2.0",
        "updated": datetime.now().isoformat(),
        "count": len(models),
        "thumbnails": thumbnails_generated,
        "models": models
    }
    
    # å†™å…¥æ–‡ä»¶
    output_path = os.path.join(models_dir, "index.json")
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(index_data, f, indent=2, ensure_ascii=False)
    
    # ç»Ÿè®¡ä¿¡æ¯
    print("=" * 60)
    print("ğŸ“Š ç”Ÿæˆç»Ÿè®¡:")
    print(f"   æ¨¡å‹æ€»æ•°: {len(models)}")
    print(f"   ç”Ÿæˆç¼©ç•¥å›¾: {thumbnails_generated}")
    
    # æŒ‰ç±»å‹ç»Ÿè®¡
    base64_count = sum(1 for m in models if m['imageType'] == 'base64')
    url_count = sum(1 for m in models if m['imageType'] == 'url')
    
    print(f"   Base64å›¾ç‰‡: {base64_count}")
    print(f"   ç½‘ç»œå›¾ç‰‡: {url_count}")
    print(f"   æ— å›¾ç‰‡: {len(models) - base64_count - url_count}")
    
    file_size = os.path.getsize(output_path) / 1024
    print(f"   æ–‡ä»¶å¤§å°: {file_size:.1f} KB")
    
    if file_size > 1000:
        print("âš ï¸  è­¦å‘Šï¼šç´¢å¼•æ–‡ä»¶è¶…è¿‡1MBï¼Œå»ºè®®æ£€æŸ¥")
    
    print("âœ… ç´¢å¼•ç”Ÿæˆå®Œæˆï¼")
    return index_data

if __name__ == "__main__":
    generate_index()
PYTHONEOF
          
          echo "âœ… è„šæœ¬åˆ›å»ºå®Œæˆ"

      - name: ğŸš€ è¿è¡Œç´¢å¼•ç”Ÿæˆ
        run: |
          echo "å¼€å§‹ç”Ÿæˆç´¢å¼•..."
          
          # æ£€æŸ¥modelsç›®å½•
          ls -la models/ || echo "modelsç›®å½•å¯èƒ½ä¸ºç©º"
          
          # è¿è¡ŒPythonè„šæœ¬
          python scripts/generate_index_with_thumbnails.py
          
          # æŸ¥çœ‹ç»“æœ
          echo "ç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶:"
          ls -lh models/index.json
          echo "å‰5ä¸ªæ¨¡å‹é¢„è§ˆ:"
          python3 -c "
import json
with open('models/index.json', 'r') as f:
    data = json.load(f)
print(f'ç‰ˆæœ¬: {data.get(\"version\")}')
print(f'æ¨¡å‹æ•°: {data.get(\"count\")}')
print(f'ç¼©ç•¥å›¾: {data.get(\"thumbnails\")}')
print(f'æ›´æ–°æ—¶é—´: {data.get(\"updated\")}')
if data.get('models'):
    for i, model in enumerate(data['models'][:5]):
        thumb = 'æœ‰' if model.get('thumbnail') else 'æ— '
        print(f'{i+1}. {model[\"name\"]} - {model[\"leds\"]} LED ({thumb}ç¼©ç•¥å›¾)')
"

      - name: ğŸ’¾ æäº¤æ›´æ–°
        run: |
          echo "æ£€æŸ¥æ›´æ”¹..."
          
          # é…ç½®Gitç”¨æˆ·
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # æ·»åŠ ç´¢å¼•æ–‡ä»¶
          git add models/index.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ”„ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæ­£åœ¨æäº¤..."
            
            # æ˜¾ç¤ºæ›´æ”¹æ‘˜è¦
            echo "æ›´æ”¹å†…å®¹:"
            git diff --cached --stat
            
            # æäº¤
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ¨¡å‹ç´¢å¼• v2.0 [skip ci]"
            
            # æ¨é€
            echo "ğŸš€ æ¨é€åˆ°GitHub..."
            git push origin main
            
            echo "âœ… æäº¤æˆåŠŸï¼"
          fi

      - name: ğŸ“‹ å®ŒæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "========================================"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸƒ å·¥ä½œæµID: ${{ github.run_id }}"
          echo "ğŸ”— è¿è¡Œé“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "========================================"
