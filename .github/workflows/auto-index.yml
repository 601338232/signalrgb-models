name: ğŸ”„ è‡ªåŠ¨åŒæ­¥æ¨¡å‹ç´¢å¼•

on:
  push:
    paths:
      - 'models/**'
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š æ‰«æå¹¶ç”Ÿæˆç´¢å¼•
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆæ¨¡å‹ç´¢å¼• ==="
          cd models
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„Node.jsè„šæœ¬
          cat > generate.js << 'EOF'
          const fs = require('fs');
          
          console.log('æ‰«æ models æ–‡ä»¶å¤¹...');
          
          // è·å–æ‰€æœ‰JSONæ–‡ä»¶
          const files = fs.readdirSync('.')
            .filter(f => f.endsWith('.json') && f !== 'index.json')
            .sort();
          
          console.log('æ‰¾åˆ°æ–‡ä»¶:', files);
          
          const models = [];
          
          files.forEach(file => {
            try {
              const content = fs.readFileSync(file, 'utf8');
              const data = JSON.parse(content);
              
              models.push({
                name: file,
                title: data.ProductName || file.replace('.json', ''),
                leds: data.LedCount || 0,
                width: data.Width || 0,
                height: data.Height || 0,
                brand: data.Brand || '',
                time: new Date().toLocaleDateString('zh-CN')
              });
              
              console.log('âœ… å¤„ç†æˆåŠŸ:', file);
            } catch(e) {
              console.log('âŒ å¤„ç†å¤±è´¥:', file, e.message);
            }
          });
          
          // åˆ›å»ºç´¢å¼•å¯¹è±¡
          const index = {
            version: '1.0',
            updated: new Date().toISOString(),
            count: models.length,
            models: models
          };
          
          // ä¿å­˜åˆ°æ–‡ä»¶
          fs.writeFileSync('index.json', JSON.stringify(index, null, 2));
          console.log('ğŸ‰ ç´¢å¼•ç”Ÿæˆå®Œæˆï¼');
          console.log('ğŸ“Š æ¨¡å‹æ•°é‡:', models.length);
          EOF
          
          # è¿è¡Œè„šæœ¬
          node generate.js
      
      - name: ğŸ’¾ æäº¤æ›´æ–°
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          
          git add models/index.json
          
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç´¢å¼•"
            git push
            echo "âœ… ç´¢å¼•å·²æ›´æ–°å¹¶æ¨é€"
          fi
