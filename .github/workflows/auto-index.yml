# .github/workflows/auto-index.yml - å®Œæ•´å¢å¼ºç‰ˆ
name: ğŸ”„ è‡ªåŠ¨åŒæ­¥æ¨¡å‹ç´¢å¼•ï¼ˆå¸¦ç¼©ç•¥å›¾ï¼‰

on:
  push:
    paths:
      - 'models/**'
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libjpeg-dev zlib1g-dev
          pip install Pillow requests

      - name: ğŸ“Š ç¬¬ä¸€é˜¶æ®µï¼šç”ŸæˆåŸºæœ¬ä¿¡æ¯
        run: |
          echo "=== ç”ŸæˆåŸºæœ¬ç´¢å¼•ä¿¡æ¯ ==="
          
          # ä½¿ç”¨Node.jså¿«é€Ÿç”ŸæˆåŸºæœ¬ä¿¡æ¯ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
          cat > generate_basic.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          console.log('ğŸ“ æ‰«æ models æ–‡ä»¶å¤¹...');
          
          let files = [];
          try {
            files = fs.readdirSync('models')
              .filter(f => f.toLowerCase().endsWith('.json') && f !== 'index.json')
              .sort();
          } catch(e) {
            console.log('âš ï¸ models æ–‡ä»¶å¤¹ä¸ºç©º');
          }
          
          console.log('æ‰¾åˆ°æ–‡ä»¶:', files.length);
          
          const models = [];
          
          files.forEach(file => {
            try {
              const content = fs.readFileSync(path.join('models', file), 'utf8');
              const data = JSON.parse(content);
              
              models.push({
                name: file,
                title: data.ProductName || file.replace('.json', ''),
                leds: data.LedCount || 0,
                width: data.Width || 0,
                height: data.Height || 0,
                brand: data.Brand || '',
                download: `https://cdn.jsdelivr.net/gh/${{ github.repository }}/main/models/${file}`
              });
              
              console.log(`âœ… ${file}`);
            } catch(e) {
              console.log(`âŒ ${file}: ${e.message}`);
            }
          });
          
          const index = {
            version: '2.0',
            updated: new Date().toISOString(),
            count: models.length,
            models: models
          };
          
          fs.writeFileSync('models/index-basic.json', JSON.stringify(index, null, 2));
          console.log('ğŸ‰ åŸºæœ¬ç´¢å¼•ç”Ÿæˆå®Œæˆï¼');
          EOF
          
          node generate_basic.js

      - name: ğŸ–¼ï¸ ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆç¼©ç•¥å›¾
        run: |
          echo "=== ç”Ÿæˆç¼©ç•¥å›¾ ==="
          
          # è¿™é‡Œæ˜¯å®Œæ•´çš„Pythonè„šæœ¬ï¼Œç”Ÿæˆå¸¦ç¼©ç•¥å›¾çš„ç´¢å¼•
          # ä»ä¸Šé¢æ•™ç¨‹ä¸­çš„è„šæœ¬å¤åˆ¶è¿‡æ¥
          cat > generate_with_thumbnails.py << 'EOF'
          # ... å®Œæ•´çš„Pythonè„šæœ¬å†…å®¹ ...
          EOF
          
          python generate_with_thumbnails.py

      - name: ğŸ’¾ æäº¤æ›´æ–°
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰ç´¢å¼•æ–‡ä»¶
          git add models/index.json models/index-basic.json
          
          if git diff --cached --quiet; then
            echo "ğŸ”„ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ¨¡å‹ç´¢å¼•ï¼ˆåŸºæœ¬+ç¼©ç•¥å›¾ï¼‰ [skip ci]"
            git push origin main
            echo "âœ… æäº¤æˆåŠŸï¼"
          fi
