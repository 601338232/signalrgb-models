name: ğŸ”„ è‡ªåŠ¨åŒæ­¥æ¨¡å‹ç´¢å¼•

on:
  push:
    paths:
      - 'models/**'
    branches: [ main ]
  workflow_dispatch:

# å…³é”®ä¿®å¤ï¼šæ·»åŠ å†™å…¥æƒé™
permissions:
  contents: write  # å…è®¸å·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub æä¾›çš„ token
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: ğŸ“Š æ‰«æå¹¶ç”Ÿæˆç´¢å¼•
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆæ¨¡å‹ç´¢å¼• ==="
          echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          
          # åˆ›å»º models æ–‡ä»¶å¤¹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p models
          cd models
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„ Node.js è„šæœ¬
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          console.log('ğŸ“ æ‰«æ models æ–‡ä»¶å¤¹...');
          
          // è·å–æ‰€æœ‰ JSON æ–‡ä»¶
          let files = [];
          try {
            files = fs.readdirSync('.')
              .filter(f => f.toLowerCase().endsWith('.json') && f !== 'index.json')
              .sort();
          } catch(e) {
            console.log('âš ï¸ models æ–‡ä»¶å¤¹ä¸ºç©º');
          }
          
          console.log('æ‰¾åˆ°æ–‡ä»¶:', files.length);
          
          const models = [];
          let success = 0;
          
          files.forEach(file => {
            try {
              console.log(`å¤„ç†: ${file}`);
              const content = fs.readFileSync(file, 'utf8');
              const data = JSON.parse(content);
              
              models.push({
                name: file,
                title: data.ProductName || file.replace('.json', ''),
                leds: data.LedCount || 0,
                width: data.Width || 0,
                height: data.Height || 0,
                brand: data.Brand || '',
                time: new Date().toLocaleDateString('zh-CN'),
                download: `https://raw.githubusercontent.com/${{ github.repository }}/main/models/${file}`
              });
              
              success++;
              console.log(`âœ… æˆåŠŸ: ${file}`);
            } catch(e) {
              console.log(`âŒ å¤±è´¥ ${file}: ${e.message}`);
            }
          });
          
          // åˆ›å»ºç´¢å¼•å¯¹è±¡
          const index = {
            version: '1.0',
            updated: new Date().toISOString(),
            count: models.length,
            success: success,
            total: files.length,
            models: models
          };
          
          // ä¿å­˜åˆ°æ–‡ä»¶
          fs.writeFileSync('index.json', JSON.stringify(index, null, 2));
          console.log('ğŸ‰ ç´¢å¼•ç”Ÿæˆå®Œæˆï¼');
          console.log(`ğŸ“Š ç»Ÿè®¡: ${success}/${files.length} æˆåŠŸ`);
          EOF
          
          # è¿è¡Œè„šæœ¬
          node generate.js
          
          # æ˜¾ç¤ºç”Ÿæˆçš„ç´¢å¼•å†…å®¹
          echo "=== ç”Ÿæˆçš„ç´¢å¼•å†…å®¹ ==="
          cat index.json | head -30

      - name: ğŸ’¾ æäº¤æ›´æ–°
        run: |
          echo "=== å¼€å§‹æäº¤æ›´æ–° ==="
          
          # é…ç½® Git ç”¨æˆ·
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # æ·»åŠ ç´¢å¼•æ–‡ä»¶
          git add models/index.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ”„ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæ­£åœ¨æäº¤..."
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ¨¡å‹ç´¢å¼• [skip ci]"
            
            # å°è¯•æ¨é€
            echo "ğŸš€ æ­£åœ¨æ¨é€åˆ° GitHub..."
            git push origin main
            
            echo "âœ… æäº¤æˆåŠŸï¼"
            
            # æ˜¾ç¤ºæäº¤ä¿¡æ¯
            echo "ğŸ“‹ æäº¤ä¿¡æ¯:"
            git log -1 --oneline
          fi
          
          echo "=== æäº¤æ­¥éª¤å®Œæˆ ==="

      - name: ğŸ“¤ ä¸Šä¼ ç»“æœï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          echo "ğŸ¯ å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸƒ å·¥ä½œæµID: ${{ github.run_id }}"
