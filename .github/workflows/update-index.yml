name: ğŸ”„ å…¨è‡ªåŠ¨æ¨¡å‹ç´¢å¼•

on:
  # ä»»ä½•å¯¹ models/ æ–‡ä»¶å¤¹çš„æ“ä½œéƒ½ä¼šè§¦å‘
  push:
    paths:
      - 'models/**'        # æ–°å¢ã€åˆ é™¤ã€ä¿®æ”¹éƒ½ä¼šè§¦å‘
    branches: [ main ]
  
  # æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'
        type: string

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ è·å–æœ€æ–°ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“Š ç”Ÿæˆæ™ºèƒ½ç´¢å¼•
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆæ¨¡å‹ç´¢å¼• ==="
          echo "ğŸ“… æ—¶é—´: $(date)"
          echo "ğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}"
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          
          cd models
          
          # åˆ›å»ºä¸€ä¸ªè¶…ç®€å•çš„ç”Ÿæˆè„šæœ¬
          cat > make-index.js << 'END'
          const fs = require('fs');
          
          console.log('ğŸ“ æ‰«æ models æ–‡ä»¶å¤¹...');
          
          // è·å–æ‰€æœ‰ JSON æ–‡ä»¶ï¼ˆæ’é™¤ index.json è‡ªå·±ï¼‰
          let files = [];
          try {
            files = fs.readdirSync('.')
              .filter(f => f.endsWith('.json') && f !== 'index.json')
              .sort();
          } catch (e) {
            console.log('âš ï¸ models æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºç©ºç´¢å¼•');
          }
          
          console.log(`æ‰¾åˆ° ${files.length} ä¸ªæ¨¡å‹æ–‡ä»¶`);
          
          const models = [];
          
          // å¤„ç†æ¯ä¸ªæ–‡ä»¶
          files.forEach(file => {
            try {
              const content = fs.readFileSync(file, 'utf8');
              const data = JSON.parse(content);
              
              models.push({
                id: file.replace('.json', ''),
                name: file,
                title: data.ProductName || file.replace('.json', ''),
                leds: data.LedCount || 0,
                size: `${data.Width || 0}Ã—${data.Height || 0}`,
                brand: data.Brand || '',
                time: new Date().toISOString().split('T')[0],
                download: `https://raw.githubusercontent.com/${{ github.repository }}/main/models/${file}`,
                raw: `https://github.com/${{ github.repository }}/blob/main/models/${file}`
              });
              
              console.log(`âœ… ${file}`);
            } catch (e) {
              console.log(`âŒ ${file}: ${e.message}`);
            }
          });
          
          // ç”Ÿæˆç´¢å¼•
          const index = {
            version: '1.0',
            updated: new Date().toISOString(),
            count: models.length,
            models: models,
            info: 'è‡ªåŠ¨ç”Ÿæˆ - æ–°å¢/åˆ é™¤/ä¿®æ”¹éƒ½ä¼šè‡ªåŠ¨æ›´æ–°'
          };
          
          // ä¿å­˜
          fs.writeFileSync('index.json', JSON.stringify(index, null, 2));
          console.log('\nğŸ‰ ç´¢å¼•ç”Ÿæˆå®Œæˆï¼');
          console.log(`ğŸ“Š ç»Ÿè®¡: ${models.length} ä¸ªæ¨¡å‹`);
          console.log(`â° æ›´æ–°æ—¶é—´: ${index.updated}`);
          END
          
          # è¿è¡Œè„šæœ¬
          node make-index.js

      - name: ğŸ’¾ è‡ªåŠ¨æäº¤æ›´æ–°
        run: |
          # é…ç½® Git
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # æ·»åŠ ç´¢å¼•æ–‡ä»¶
          git add models/index.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ”„ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            # æäº¤
            git commit -m "ğŸ“± è‡ªåŠ¨æ›´æ–°ç´¢å¼•ï¼ˆæ“ä½œè€…: ${{ github.actor }}ï¼‰"
            git push
            echo "âœ… ç´¢å¼•å·²æ›´æ–°å¹¶æ¨é€"
          fi

      - name: ğŸ“± ç”Ÿæˆæ‰‹æœºå‹å¥½é¡µé¢
        run: |
          cd models
          
          # åˆ›å»º HTML æŸ¥çœ‹é¡µé¢ï¼ˆæ‰‹æœºå‹å¥½ï¼‰
          cat > index.html << 'HTML'
          <!DOCTYPE html>
          <html>
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>ğŸ“± æ‰‹æœºæ¨¡å‹åº“</title>
            <style>
              * { margin:0; padding:0; box-sizing:border-box; }
              body { font-family: -apple-system, sans-serif; padding:15px; background:#f5f5f7; }
              .header { background:#fff; padding:20px; border-radius:15px; margin-bottom:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
              h1 { color:#333; font-size:22px; margin-bottom:5px; }
              .info { color:#666; font-size:14px; margin-bottom:15px; }
              .model-list { display:grid; gap:12px; }
              .model-card { background:#fff; padding:18px; border-radius:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
              .model-name { font-size:18px; font-weight:600; color:#007AFF; margin-bottom:5px; }
              .model-meta { display:flex; gap:15px; margin-top:10px; font-size:13px; color:#666; }
              .model-meta span { background:#f0f0f0; padding:4px 10px; border-radius:10px; }
              .actions { margin-top:15px; display:flex; gap:10px; }
              .btn { flex:1; text-align:center; padding:12px; border-radius:10px; text-decoration:none; font-weight:500; }
              .btn-download { background:#007AFF; color:white; }
              .btn-view { background:#f0f0f0; color:#333; }
              .footer { margin-top:25px; text-align:center; color:#999; font-size:12px; padding:15px; }
              .empty { text-align:center; padding:50px; color:#999; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>ğŸ“± æ‰‹æœºæ¨¡å‹åº“</h1>
              <div class="info">å…± <span id="count">0</span> ä¸ªæ¨¡å‹ â€¢ æœ€åæ›´æ–°: <span id="time">-</span></div>
              <div style="display:flex; gap:10px; margin-top:15px;">
                <a href="https://github.com/${{ github.repository }}/upload/main/models" 
                   style="flex:1; background:#34C759; color:white; text-align:center; padding:12px; border-radius:10px; text-decoration:none;">
                  ğŸ“¤ ä¸Šä¼ æ–°æ¨¡å‹
                </a>
                <a href="https://github.com/${{ github.repository }}/tree/main/models" 
                   style="flex:1; background:#8E8E93; color:white; text-align:center; padding:12px; border-radius:10px; text-decoration:none;">
                  ğŸ“ ç®¡ç†æ–‡ä»¶
                </a>
              </div>
            </div>
            
            <div id="model-list" class="model-list">
              <!-- æ¨¡å‹åˆ—è¡¨ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <div class="footer">
              <p>ğŸ“² æ‰‹æœºæ“ä½œæç¤ºï¼šç‚¹å‡»"ä¸Šä¼ æ–°æ¨¡å‹"å¯æ·»åŠ æ–‡ä»¶ï¼Œåœ¨"ç®¡ç†æ–‡ä»¶"ä¸­å¯åˆ é™¤æ–‡ä»¶</p>
              <p>âœ¨ æ‰€æœ‰æ“ä½œéƒ½ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ç¼–è¾‘å™¨</p>
            </div>
            
            <script>
              // åŠ è½½ç´¢å¼•æ•°æ®
              fetch('index.json')
                .then(r => r.json())
                .then(data => {
                  document.getElementById('count').textContent = data.count;
                  document.getElementById('time').textContent = new Date(data.updated).toLocaleString('zh-CN');
                  
                  const container = document.getElementById('model-list');
                  
                  if (data.models.length === 0) {
                    container.innerHTML = '<div class="empty">ğŸ“­ è¿˜æ²¡æœ‰æ¨¡å‹æ–‡ä»¶ï¼Œç‚¹å‡»ä¸Šæ–¹"ä¸Šä¼ æ–°æ¨¡å‹"å¼€å§‹æ·»åŠ </div>';
                    return;
                  }
                  
                  data.models.forEach(model => {
                    const card = document.createElement('div');
                    card.className = 'model-card';
                    card.innerHTML = `
                      <div class="model-name">${model.title}</div>
                      <div>æ–‡ä»¶: ${model.name}</div>
                      <div class="model-meta">
                        <span>${model.leds} LED</span>
                        <span>${model.size}</span>
                        ${model.brand ? `<span>${model.brand}</span>` : ''}
                      </div>
                      <div class="actions">
                        <a href="${model.download}" class="btn btn-download" download="${model.name}">â¬‡ï¸ ä¸‹è½½</a>
                        <a href="${model.raw}" target="_blank" class="btn btn-view">ğŸ‘ï¸ æŸ¥çœ‹</a>
                      </div>
                    `;
                    container.appendChild(card);
                  });
                })
                .catch(e => {
                  document.getElementById('model-list').innerHTML = '<div class="empty">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                });
            </script>
          </body>
          </html>
          HTML
          
          echo "ğŸ“± æ‰‹æœºæŸ¥çœ‹é¡µé¢å·²ç”Ÿæˆ: models/index.html"

      - name: ğŸŒ ç”Ÿæˆè®¿é—®é“¾æ¥
        run: |
          echo "ğŸ‰ è®¾ç½®å®Œæˆï¼"
          echo "ğŸ“Š ç´¢å¼•æ–‡ä»¶: https://raw.githubusercontent.com/${{ github.repository }}/main/models/index.json"
          echo "ğŸ“± æ‰‹æœºé¡µé¢: https://htmlpreview.github.io/?https://raw.githubusercontent.com/${{ github.repository }}/main/models/index.html"
          echo "ğŸ“ ä¸Šä¼ åœ°å€: https://github.com/${{ github.repository }}/upload/main/models"
